---
title: "Bank Marketing"
output:
  html_document:
    df_print: paged
    fig_caption: yes
    number_sections: yes
  pdf_document: default
---

<style type="text/css">

body{ /* Normal  */
      font-size: 18px;
  }

</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE,message=FALSE,warning=FALSE)
```

***

Team ID:

Name (tasks):

Name (tasks):

Name (tasks):

Auditor (tasks):

***

# Introduction

This document demonstrates a basic template for the final report for STA 141A, FALL 2020. Depending on the project, you may not need to include all subsections in your report. 


<span style="color:red">Note: </span> You may use this `.rmd` file to draft your final report. However, this report contains unpolished tables and figures, and results without interpretation, which should not be presented in your final report. This is important. 

## Background


<span style="color:red">Note: </span>  Discuss the basic background of this project here, even if you pick one of the two provided data sets. In particular, you are expected to briefly comment on the importance of this analysis, and explain the goals of this project. For instance, you can write two short paragraphs as follows.

In this project, we analyze the data from a Phase II study of patients with non-small cell lung cancer.
The double-blind randomized multicenter clinical trials studied whether using docetaxel and TFD725 would prolong survival of patients diagnosed with NSCLC compared to using only docetaxel alone.

The primary scientific question of interest is whether second line chemotherapy using docetaxel and TFD725 associated with prolonged survival compared to docetaxel alone. In this project, we would also like to estimate the survival rate of patients over the period of study given the baseline covariates. In addition, we will test whether the treatment effects, if any, depend on the regions of patients, indicator that patient had an abnormal LDF level, or indicator that patient had an abnormal alkaline phoshatase level.

Mention an y relevant literature here. For example, if you are doing classification, you can write something like: Recently there has been significant improvment in the boosting algorithm known as XGboost [1]. This is good for use because...

[1] Chen, T., and C. Guestrin. "XGBoost: A scalable tree boosting system. arXiv 2016." arXiv preprint arXiv:1603.02754.

## Statistical questions of interest


<span style="color:red">Note: </span>  Translate the scientific goals into statistical questions that can be answered with appropriate statistical analysis on the given data.

To answer the primary scientific question of interest, we propose to fit a linear regression with the observation time (from randomization) as the response and the indicator of region, age, indicator of gender, indicator of advanced stage, indicator for whether patient had an abnormal LDF level at time of randomization, indicator whether patient had an abnormal alkaline phoshatase level at time of randomization, and patient's performance on ECOG scale as covariates. To answer the secondary questions of interest, we will use the Cox proportional hazard model to estimate the survival rate, and we will add interaction terms between the treatment indicator and the regions of patients, indicator that patient had an abnormal LDF level, or indicator that patient had an abnormal alkaline phoshatase level.


# Analysis Plan


<span style="color:red">Note: </span>  It is best practice to write down the statistical analysis plan before analyzing data. This can significantly improve the rigorousity and reproducibility of the analysis, and avoid false discovery. This section should just be an extended version of your initial proposal. It is often inevitable that one may need to alter the analysis plan for unexpected features in the data. However, detailed documentation of the changes will shed light on unique features of the data set and help future analysis.


## Population and study design


<span style="color:red">Note: </span>  Discuss the target population of this analysis, and how the study is design to collect representative data for this population.

## Statistical Analysis

### Descriptive Analysis


<span style="color:red">Note: </span>  Describe the descriptive analysis you plan to conduct on the data set. The goal of the descriptive analysis is to provide an overview of the data set (and the study that collects the data) beforing diving into the analysis.

We will summarize the distribution of each variables for patients in the treatment group and the control group. Based on the summary statistics, we will evaluate whether the randomization is successful. To be specific, all summary statistics of baseline variables should be similar between the treatment and control groups.

We will estimate the survival function of patients in the treatment and control groups using Kaplan-Meier estimates, without adjusting for any covariates. Furthermore, we will summarize the distribution of observation time and the patients' status at the end of study in groups defined by treatment, regions of patients, indicator that patient had an abnormal LDF level, or indicator that patient had an abnormal alkaline phoshatase level.

### "Main" Analysis


<span style="color:red">Note: </span>  Describe the analysis you plan to conduct to answer the questions of interest. Remember to rename the section title to fit the actual analysis you propose, e.g., inferential analysis, clustering, prediction model, etc. For instance, in this report, this section should explain

* Detailed model specification of linear regression model.
* Description of the Cox proportional hazard model.
* Description of the model with interactions.

# Mention methods implemented for extra-credit seprately

* Implement a method not discussed in class for one task
* Explain why you chose this method
* You can be asked questions about this in the presentation



# Results

<span style="color:red">Note: </span> In this template, we present the unpolished tables and figures generated with generic `r` functions, and we skip all interpretation of the analysis results.  You can adapt any functions in this section in your report.


## Descriptive Analysis


<span style="color:red">Note: </span> There are many ways to automatically generate summary tables in `R`, of which many would even generate html or latex tables. In this template, we will use the package `qwraps2` as an example ([link](https://cran.r-project.org/web/packages/qwraps2/vignettes/summary-statistics.html)).

```{r }
library(dplyr)
library(tidyr)
library(qwraps2)

options(digits = 3)  

set.seed(1) # Read more about RNGs with ?set.seed

### Read data
nsclc_data <- read.table("nsclc-modified.txt", header = TRUE)

excluded_vars = c("ptid","tx");
table1_summary <-  nsclc_data %>%   select(.,-one_of(excluded_vars)) %>%  qsummary(.)

table1 =nsclc_data %>% group_by(.data$tx) %>%
  summary_table(., table1_summary)

rgroups =   rep(4,length(names(nsclc_data))-2)
names(rgroups)=names(nsclc_data)[!names(nsclc_data)%in%excluded_vars]

qable(table1,markup='markdown',rgroup=rgroups)
```




```{r}
nsclc_data.trt= nsclc_data %>% filter(tx == 1);
nsclc_data.ctrl= nsclc_data %>% filter(tx == 0);
table2_summary.trt <- nsclc_data.trt %>%   select("obstime","survival.past.400") %>%  qsummary(.)
table2_summary.ctrl <- nsclc_data.ctrl %>%   select("obstime","survival.past.400") %>%  qsummary(.)

table2=list();
table2.trt=list();
table2.ctrl=list();
bin_list = c("europe",             "abnLDH","abnAlkphos")
for(i_var in 1:length(bin_list)){
(table2.trt[[i_var]] =nsclc_data.trt %>% group_by(.data[[bin_list[i_var]]]) %>% summary_table(., table2_summary.trt))
(table2.ctrl[[i_var]] =nsclc_data.ctrl %>% group_by(.data[[bin_list[i_var]]]) %>% summary_table(., table2_summary.ctrl))

table2[[i_var]] = cbind(table2.trt[[i_var]],table2.ctrl[[i_var]]);
}
rgroups2 =   rep(4,2)
names(rgroups2)=c("obstime","survival.past.400")
```

<span style="color:red">Note: </span>  Draw the Kaplan-Meier curve with no adjusted variables [Link](https://rviews.rstudio.com/2017/09/25/survival-analysis-with-r/).

```{r}
library(ggplot2)
library(survival)
library(ggfortify)
km_fit <- survfit(Surv(obstime, death) ~ tx, data=nsclc_data)

autoplot(km_fit)
```

```{r}
qable(table2[[1]],markup="markdown",rgroup=rgroups2)
```


```{r}
qable(table2[[2]],markup="markdown",rgroup=rgroups2)
```


```{r}
qable(table2[[3]],markup="markdown",rgroup=rgroups2)
```

## Inferential Analysis

```{r, cache = TRUE, message=FALSE}
library(lmtest)
library(sandwich)

nsclc_data.lm=lm(obstime~tx+europe+age+male+advdis+response+abnLDH+abnAlkphos+as.factor(ECOG),data=nsclc_data);

nsclc_data.robust_lm=coeftest(nsclc_data.lm, vcov = vcovHC(nsclc_data.lm, type="HC1"))

tmp=matrix(nsclc_data.robust_lm,nrow=dim(nsclc_data.robust_lm)[1],ncol=dim(nsclc_data.robust_lm)[2])
dimnames(tmp)=dimnames(nsclc_data.robust_lm);

caption_text = paste('Table 3: Results of multiple linear regression', sep='')
knitr::kable(
 tmp,  caption = caption_text
)
```



```{r,message=FALSE}
### Fit a Cox proportional hazard model

nsclc_data.cox <- coxph(Surv(obstime, death) ~tx+europe+age+male+advdis+response+abnLDH+abnAlkphos+as.factor(ECOG), data = nsclc_data)

sum_cox=summary(nsclc_data.cox)

caption_text = paste('Table 4: Results of Cox proportional hazard model', sep='')
knitr::kable(
 sum_cox$coef,  caption = caption_text
)
```

Check if adding more interactions will change results.

```{r}

nsclc_data.cox_int <- coxph(Surv(obstime, death) ~tx*(europe+age+male+advdis+response+abnLDH+abnAlkphos)+as.factor(ECOG), data = nsclc_data)

sum_cox_int=summary(nsclc_data.cox_int)

caption_text = paste('Table 5: Results of Cox proportional hazard model with interaction terms', sep='')
knitr::kable(
 sum_cox_int$coef,  caption = caption_text
)

```
```{r}
lklh_ratio=anova(nsclc_data.cox_int,nsclc_data.cox)

```

The likelihood ratio test for the two models yields a p-value of `r lklh_ratio[[4]][2]`.

# Mention results for extra-credit method (if any) 

* Mention results for extra-credit method here
# Discussion

<span style="color:red">Note: </span> Discuss the limitations of the presented projects, and comment on how this project enlightens future research or analysis.

# Session information
```{r}
print(sessionInfo(), local = FALSE)
```
